services:
  # Using host system's Solana validator (already running on ports 8899/8900)
  # No container needed - blockchain will be on system terminal

  backend-api:
    build: .
    container_name: supply-chain-backend
    ports:
      - "8000:8000"  # Backend API Server
    volumes:
      - ./data:/app/data
      - ./blockchain_data:/app/blockchain_data
      - ./solana_wallets.json:/app/solana_wallets.json
      - ./agents:/app/agents
      - ./utils:/app/utils
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - SOLANA_RPC_URL=http://host.docker.internal:8899
      - SOLANA_WS_URL=ws://host.docker.internal:8900
      - PYTHONUNBUFFERED=1
    networks:
      - supply-chain-network
    command: >
      sh -c "
        echo 'ðŸš€ Starting Backend API Server...' &&
        python api_server.py
      "

  supply-chain-agents:
    build: .
    container_name: supply-chain-agents
    depends_on:
      - backend-api
    ports:
      - "8001:8001"  # Inventory Agent
      - "8002:8002"  # Demand Agent
      - "8003:8003"  # Route Agent
      - "8004:8004"  # Supplier Agent
    volumes:
      - ./data:/app/data
      - ./blockchain_data:/app/blockchain_data
      - ./solana_wallets.json:/app/solana_wallets.json
      - ./agents:/app/agents
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - SOLANA_RPC_URL=http://host.docker.internal:8899
      - SOLANA_WS_URL=ws://host.docker.internal:8900
      - PYTHONUNBUFFERED=1
    networks:
      - supply-chain-network
    command: >
      sh -c "
        echo 'ðŸ¤– Starting Supply Chain AI Agents...' &&
        python agents/inventory_agent.py > /app/agents/inventory_agent.log 2>&1 &
        python agents/demand_forecasting_agent.py > /app/agents/demand_agent.log 2>&1 &
        python agents/route_optimization_agent.py > /app/agents/route_agent.log 2>&1 &
        python agents/supplier_coordination_agent.py > /app/agents/supplier_agent.log 2>&1 &
        echo 'âœ… All agents started' &&
        tail -f /dev/null
      "

networks:
  supply-chain-network:
    driver: bridge
